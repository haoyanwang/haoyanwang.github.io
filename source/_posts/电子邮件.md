---
title: 电子邮件
top: false
cover: false
toc: true
mathjax: true
date: 2021-02-23 13:42:17
password:
summary:
tags:
categories:
---

# 电子邮件
最近在发邮件服务上遇到点问题，所以深入研究一下电子邮件的原理细节（因为自己个人不经常使用，总有一种email很久远的感觉）

## 相关概念
### 邮件
邮件是一种消息的格式，由信封、首部和正文组成。

- 信封上最重要的是收信人的地址。邮件服务器用这个地址将邮件发送到收信人所在的邮件服务器上。
- 首部是由用户代理或邮件服务器添加的一些信息。包括Received、Message-ID、From、Data、Reply-To、X-Phone、X-Mailer、To和Subject等字段。
- 正文是是发送用户发给接收用户报文的内容。

### 用户代理
用户代理UA（User Agent）是用户与电子邮件系统的交互接口，一般来说它就是我们PC机上的一个程序。Windows上常见的用户代理是Foxmail和Outlook客户端。
用户代理提供一个好的用户界面，它提取用户在其界面填写的各项信息，生成一封符合SMTP等邮件标准的邮件，然后采用SMTP协议将邮件发送到发送端邮件服务器。

### 邮件的收发过程
一般情况下，一封邮件的发送和接收过程如下。

1. 发信人在用户代理里编辑邮件，包括填写发信人邮箱、收信人邮箱和邮件标题等等。
2. 用户代理提取发信人编辑的信息，生成一封符合邮件格式标准的邮件。
3. 用户代理用SMTP将邮件发送到发送端邮件服务器（即发信人邮箱所对应的邮件服务器）。
4. 发送端邮件服务器用SMTP将邮件发送到接收端邮件服务器（即收信人邮箱所对应的邮件服务器）。
5. 收信人调用用户代理。用户代理用POP3协议从接收端邮件服务器取回邮件。
6. 用户代理解析收到的邮件，以适当的形式呈现在收信人面前。

## 电子邮件相关协议
### SMTP协议（Simple Mail Transfer Protocal）
SMTP协议是用于发送方的邮件服务器发送报文到接收方邮件服务器。它是一种推协议，通常它工作在两种情况下：一是邮件从客户机传输到服务器；二是从某一个服务器传输到另一个服务器。
SMTP协议基于 [TCP协议](https://haoyanwang.github.io/2020/12/20/TCP-IP%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/#TCP) ，监听25号端口。
PC通过邮件客户端使用SMTP协议将邮件，推送到邮件服务器上
邮件服务器再通过SMTP协议，将邮件送到对方的邮件服务器上，等到对方上网的时候，就可以收到你所寄的信
（个人不是很理解为什么不使用HTTP协议推送呢，也许因为当时HTTP协议还不够成熟？也有说法是HTTP是一种拉取协议，这里需要的是一种推送协议）

![avatar](https://img-blog.csdn.net/20180720142251413?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpdW1pYW9jbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70) 

一个具体的SMTP通信（如发送端邮件服务器与接收端服务器的通信）的过程如下：
1. 发送端邮件服务器（以下简称客户端）与接收端邮件服务器（以下简称服务器）的25号端口建立TCP连接。
2. 客户端向服务器发送各种命令，来请求各种服务（如认证、指定发送人和接收人）。
3. 服务器解析用户的命令，做出相应动作并返回给客户端一个响应。
4. 2和3交替进行，直到所有邮件都发送完或两者的连接被意外中断。  
具体例子、命令以及响应见参考链接

SMTP的优缺点
- 邮件内容受限
因为SMTP协议采用ASCII码进行编码
二进制文件、声音和动画等其他复杂内容，实现起来将十分困难，所以RFC标准就扩展了新的电子邮件标准，MIME（Multipurpose Internet Mail Extensions，多用途互联网邮件扩展类型）
MIME最早应用于电子邮件系统，但后来也应用到浏览器。服务器会将它们发送的多媒体数据的类型告诉浏览器
- 命令过于简单，没提供认证等功能   
ESMTP是添加了用户认证功的SMTP

### MIME协议
MIME协议通过改进邮件头和邮件体，试图在不改变SMTP协议和邮件格式标准的基础上，使得邮件可以传输任何二进制文件。
在邮件头内指定MIME-Version、Content-Type和Content-Transfer-Encoding等字段

#### Content-Type（内容类型域）
由主类型/子类型组成，来指定邮件体的类型，常见的有text/plain（纯文本）和text/html（html邮件）

#### Content-Transfer-Encoding（传送编码域）
共有Base64、Quoted-printable，7bit，8bit和Binary几种类型

### 编码方式
#### 7位ASCII码
由7位二进制组成，可表示128个字符，其中包括95个可打印字符和33个控制字符
其中48～57为0到9十个阿拉伯数字，65～90为26个大写英文字母，97～122号为26个小写英文字母，其余为一些标点符号、运算符号等。
#### Quoted-printable编码
Quoted-printable编码用一些可打印常用字符，表示一个字节（8位）中所有非打印字符方法
33个不可打印字符，可编码为3个字符：一个等号”=”后跟随两个十六进制数字(0–9或A–F)表示该字节的数值.例如，ASCII码换页符（十进制值为12）可以表示为”=0C”
详细规则见[参考阅读](http://blog.chacuo.net/494.html)

例如：
If you believe that truth=beauty, then surely mathematics is the most beautiful branch of philosophy. 
编码后结果是：
If you believe that truth=3Dbeauty, then surely=20=
mathematics is the most beautiful branch of philosophy.
#### Base64编码
Base64是网络上最常见的用于传输8Bit字节码的编码方式之一，Base64就是一种基于64个可打印字符来表示二进制数据的方法。
64个可打印字符的索引，['A', 'B', 'C', ... 'a', 'b', 'c', ... '0', '1', ... '+', '/']，这是标准的Base64协议规定。
转换步骤：
1. 将待转换的字符串每三个字节分为一组，每个字节占8bit，那么共有24个二进制位。
2. 将上面的24个二进制位每6个一组，共分为4组。
3. 在每组前面添加两个0，每组由6个变为8个二进制位，总共32个二进制位，即四个字节。
4. 根据Base64映射表，获得对应的值
特点：
- 大多数编码都是由字符串转化成二进制的过程，而Base64的编码则是从二进制转换为字符串。与常规恰恰相反，
- Base64编码主要用在传输、存储、表示二进制领域，不能算得上加密，只是无法直接看到明文。也可以通过打乱Base64编码来进行加密。
- 中文有多种编码（比如：utf-8、gb2312、gbk等），不同编码对应Base64编码结果都不一样。
- 上面我们已经看到了Base64就是用6位（2的6次幂就是64）表示字符，因此成为Base64。同理，Base32就是用5位，Base16就是用4位。

具体例子和特殊情况见[参考阅读](https://blog.csdn.net/wo541075754/article/details/81734770)

### POP3（Post Office Protocol-3，邮局协议版本3）
邮件客户端连接邮件服务器，并下载所有未阅读的电子邮件
默认端口：110
传输协议：TCP
架构结构：C/S
访问模式：离线访问

POP3有三种生命周期：
- 确认
- 操作
- 更新

参考链接：  
[SMTP协议分析](https://blog.csdn.net/liangxiaozhang/article/details/7841975?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-3.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-3.control)
[使用Telnet学习SMTP协议](https://liumiaocn.blog.csdn.net/article/details/81131420?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-5.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-5.control)
[MIME协议详解](https://wenku.baidu.com/view/0af3cfb905087632311212be.html)
[Base64编码详解](https://blog.csdn.net/wo541075754/article/details/81734770)
[Quoted-printable 编码介绍、编码解码转换](http://blog.chacuo.net/494.html)

## 编辑电子邮件
### HTML格式的电子邮件
编写电子邮件模板不是一个愉快的体验，因为电子邮件客户端的解析引擎并不是常见的浏览器，会有各种兼容性问题
例如：
- 需要使用Table+css的布局
- 仅仅支持内联css，不支持style标签以及引入的css
- 不支持min-width和max-width
- 不支持任何margin
- 不支持任何定位属性
等等一系列问题（个人感觉需要一个大手子来淘汰电子邮件的html。现在虽然有用来兼容的库，但是学习这些不同的库，了解这些问题也是需要成本的）



