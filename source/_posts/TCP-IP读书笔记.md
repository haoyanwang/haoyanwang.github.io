---
title: TCP/IP读书笔记
top: false
cover: false
toc: true
mathjax: true
date: 2020-12-20 22:33:19
password:
summary:
tags:
categories:
---

# TCP/IP读书笔记
从小学开始就鼓捣电脑，很早就听说了类似ip、mac地址，VLAN,WLAN,猫，子网掩码，DNS地址等技术名词。
上学以后也学习了计算机网络，听说了类似OSI七层模型，TCP、UDP等概念。
工作以后也接触到了更多的网络知识，但一直是知其然不知其所以然，缺乏比较系统的学习，所以今天就记录一下学习的过程。

## 网络规则
二进制数字到底经过了那些步骤，最后构成了网络世界？

### OSI七层模型
根据主要负责的功能不同，我们将通信过程分为7层，自下而上分别为
- 物理层（数字信号）
- 数据链路层（设备之间传输的数据帧，代表名词：以太网）
- 网络层（地址管理和路由选择，代表名词：IP协议）
- 传输层（负责节点之间的数据传递，代表名词：TCP，UDP）
- 会话层
- 表示层
- 应用层
在TCP/IP五层模型中
会话层、表示层和应用层可统称应用层（代表名词：HTTP，HTTPS，FTP，DNS）

TCP/IP协议其实代表的是一组协议，不仅仅代表传输层和网络层的TCP和IP协议，还包含了其他的协议，例如HTTP，TELNET，ARP等重要协议

### 物理层，数据链路层
TCP/IP中没有严格规定该层，只要求能给上层（网络层）提供一个访问接口，以太网是最常见的形式

#### 以太网帧
数据链路层会将二进制数封装为以太网帧，以便上层协议使用
以太网帧格式：
- 目的地址、源地址（解释了从哪里来，到哪里去，分别为48位的MAC地址）
- 类型（以太网帧的类型，有数据信号和ARP握手信号）
- 数据类型
- CRC校验（确认是否被破坏）

#### MAC地址（Media Access Control媒体访问控制）
网卡、交换机和路由器的每个端口有一个独一无二的MAC地址，为48位二进制数，通常表示为12位16进制数

#### ARP协议
在网络层中，主机之间的信息传递通过IP来进行，但是对于一台主机而言，底层的硬件和IP并没有直接的关系，也就是说，当数据包到达目标机器底层时，硬件并不知道这个数据包是否属于自己
那么底层硬件如何判别呢？答案是：MAC地址（硬件只知道MAC地址），一台主机会通过ARP协议来了解整个以太网络
一台主机连接到以太网以后会发生以下事情：
1. 主机a发送一种类型为ARP的以太网帧。这个帧携带了a的MAC地址，IP地址以及目的地b的IP地址，并将目的地的MAC地址写为00000000，并发给以太网中所有的主机
2. 当以太网中的主机收到后，会查看自己的IP地址是否与目标地IP一致，如果一致，就将自己的MAC地址返回给a。这样a与b就互相知道了对方的IP地址与MAC地址
3. 每台主机就可以有一个地址映射表，可以不用发送ARP就可以直接进行IP通信。并且定期清楚掉不需要的数据，这样做可以让任何主机随时接入和退出以太网
这样，在同一个局域网内的寻址问题就解决了，那么跨局域网的寻址是如何进行的？

### 网络层
俗称IP层。IP是一个不可靠的，无连接协议，接受来自传输层的数据，将具有目的地址的分组封装后，通过路由发送给下层。IP负责分配地址并将数据以IP包的形式传送到正确的目的地

#### IP地址
##### IPv4
IPv4地址是一个32位二进制数，用4段8位二进制数分开。
其中可以分为两部分：网络号和主机号
网络号表示ip属于互联网的哪一个网络
主机号表示ip属于该网络中的哪一台主机
根据网络号和主机号的长度以及用途，ip地址可分为A，B，C，D，E五类地址
A类IP：0.0.0.0~127.255.255.255（后24位为主机地址）（126个A类网络，可连接1677214台主机）（默认掩码255.0.0.0/8）
B类IP：128.0.0.0~191.255.255.255（后16位为主机地址）（大约16000个B类网络，可连接65534台主机）（默认掩码255.255.0.0/16）
C类IP：192.0.0.0~223.255.255.255（后8位为主机地址）（每个C类主机可连接254台主机）（默认掩码255.255.255.0/24）
D类IP：224.0.0.0~239.255.255.255（组播地址）
E类IP：240.0.0.0~255.255.255.255（扩展和实验开发与研究）
其中根据用途和安全性的不同，又可以分为公网地址和私网地址

为了减少ip地址的浪费，所以使用子网掩码来将一个网络划分为多个子网
子网掩码（是一个32位二进制数，屏蔽ip地址的一部分用来区分网络地址和主机地址）
子网掩码由1和0组成，且1和0必须分别连续，例如：11111111 11111111 11111111 11100000，左边是网络位用1表示，右边是主机位用0表示
通过子网掩码，才能表明一台主机所在的子网与其他子网的关系，使网络正常工作，以免造成ip地址的浪费

如何用子网掩码得到网络号/主机号：
将ip与子网掩码化为二进制，做与运算得到网络号
将子网掩码取反后，做与运算得到主机号
举例说明：
假设ip地址为：192.168.127.101
子网掩码为：255.255.255.192
分别转二进制后做与运算，再转为十进制得到：192.168.127.64，这便是网络号
子网掩码转二进制取反后做与运算，再转十进制得到：100101，十进制为37，这便是主机号
网络号不变，主机号全取1，便是广播地址，即192.168.127.127
主机号为6位二进制数，所以能容纳的主机数量为：2的6次方-2=62（去除网络号和广播地址），能容纳的主机数量为62个（实际上还要再减去一个网关的地址）


VLSM（Variable Length Subnetwork Mask，可变长子网掩码）
指一个网络可以用多个掩码进行配置，从主机号的部分借位作为网络号（A类有24位可借，B类有16位可借，C类有8位可借），可以更方便的将一个网络划分为多个子网
例如：你被分配了一个C类地址，网络号为192.168.10.0,而你现在需要将其划分为三个子网,其中一个子网有100台主机,其余的两个子网有50台主机
这个时候VLSM就派上了用场

CIDR（Classless Inter-Domain Routing，无类别域间路由选择，也称超网）
和VLSM刚好相反，从网络号中借位给主机号，将IP网络地址空间看成是一个整体，并划分成连续的地址块。然后，采用分块的方法进行分配
CIDR可以限制路由器中的路由表增大，减少路由通告
参考阅读：
[子网掩码快速算法及可变长掩码](https://blog.csdn.net/weixin_34080951/article/details/92511829)

##### NAT（Network Address Translation网络地址转换）
目的：为了节省IPv4地址 
NAT有三种机制：
- 静态NAT（虚拟地址与公网地址1对1映射，无法解决ip地址紧缺对问题）
- 动态地址NAT（内部ip临时分配外部ip，不需要长期连接到外网上）
- 网络地址端口转换NAPT（将内部地址分配到外部地址不同的TCP端口上）（从外部看，所有信息来源与同一个ip，但又能精确识别来自那台主机）

#### IP包的转发规则
1. IP包会根据目的地进行转发，如果没有明确的下一站的地址，就会按照缺省网关的路径前进（大部分为以太网的出口路由器）
2. 当IP包到达出口路由器，路由器会根据自身的路由表，将IP包通过合适的端口送出去

#### 路由协议
路由协议分为两种
- 静态路由（手动填写，只有缺省路由表和小型网络会使用，不灵活，维护成本高）
- 动态路由（路由和相邻的路由互相通信，交换信息，最终获得全网的路由信息）
动态路由协议又分为
- 内部路由协议（距离矢量算法，链路状态算法）
- 外部路由协议（BGP协议是唯一的外部路由协议）
内外是一个相对的概念，路由协议相对的是自治域（AS）来说的
自治域就是一张拥有独立网络调控功能，统一策略的IP网络（例如家庭企业接入网络，教育、金融专用网等等）
且一个自治与有且只有一个管理者（各大运营商），但一个管理者可以拥有多个自治域

内部路由协议中的距离矢量算法和链路状态算区别是什么？
- 距离矢量路由协议
交换的是相邻路由的路由表，路由器不知道完整的拓扑结构，链路发生变化后，路由条目维护成本较大，所以不适合大型网络
#### IGP（内部路由协议）
##### RIP2协议
RIP2是路径成本算法最简单的一个，仅仅根据路由需要经过的跳转数进行判断。如果有2条路线，一条经过5个路由器，一条经过10个路由器，RIP2算法就会选择第一条
因为简单，所以不会考虑阻塞程度等因素，所以适合于较小的网络结构

- 链路状态路由协议
路由交换链路状态，交换完成后，路由器会拥有全网的拓扑结构，再根据算法计算出路径。采用增量更新，链路发生变化，只需要告诉有关路由器。
##### IS-IS协议（主流协议）
收集网络内的节点和链路状态，构建出一个链路数据库，根据算法计算出最优路径（优先AS域内的跳转）
IS-IS分层：
L1普通区域，是区域内路由，只保留本区域的路由（村民）
L12，负责区域间的数据交换，通常位于区域边界上（村长）
L2骨干区域，是区域间路由，保存骨干区的路由（乡长）
工作原理：
1. 建立连接关系（通过L12，L2互相通信）
2. 链路状态信息泛洪（将信息互相发送给邻居，达到链路状态数据库的一致性）
计算路径：
狄杰斯特拉算法（广度优先计算最短路径）

##### OSPF（Open Shortest Path First，开放式最短路径优先协议）
与IS-IS类似
#### EGP（外部路由协议）
##### BGP（Border Gateway Protocol，边界网关协议）
外部路由协议的层次更高，适用于不同AS之间的路由传播，没有发现和计算路由的功能，而是着重于控制路由传播和选择更好的路由。
外部协议是基于内部协议之上的，进行BGP传播的路由器首先要确保IGP可达。BGP需要人工配置，并建立在TCP协议之上，端口号为179

### 传输层
TCP和UDP协议属于该层
#### TCP
TCP为了保证可靠性，采用了数据分块，维护计时器，发送确认，校验和计算，丢弃重复数据和流量控制等方式
TCP是一种面向字节流的服务，它并不关心自己传送的是二进制、ASCII码还是其他的什么，连接双方的高层协议负责对数据进行解释

#### UDP
UDP擅长查询-应答服务，交换的信息量少

### 安全机制
#### IP层的安全机制
针对IP报文进行加密，有认证头（Authentication Header）以及封装安全有效负荷（Encapsulating Security Payload，ESP）
优点：底层加密，上层应用无感知
缺点：统一加密，性能下降
应用：IP VPN（Virtual Private Network）（在公网上封装加密数据通信隧道）

#### 传输层的安全机制
TCP：通信加密和安全认证
优点：基于进程和进程之间的加密
应用：BSD Sockets，传输层接口（TLI）
UDP：很难建立安全机制

#### 应用层的安全机制
IP层与传输层的安全机制之间所有的消息都要加密，无法区分不同文件的安全性要求，所以必须借助应用层的安全机制
应用：HTTPS（HTTP+TSL）

#### 常见FQ工具的加密原理（具体源码细节日后再研究...）
##### shadowsocks
shadowsocks在本地（sslocal）建立socket5（位于传输层和会话层之间的通信协议）加密服务，发送给ssserver后请求内容

##### V2Ray，Trojan
WebSocket+TLS，模拟HTTPS

（依稀记得前同事说他挖了V2Ray的bug，因为模拟浏览器数据不够严谨，所以能被识别。其他的方式还有解同步暴力拆Q的方式（不推荐），自己日后再慢慢研究
参考阅读：
- [V2Ray、Trojan等主流工具安全吗？](https://www.idleleo.com/10/4766.html)
- [V2Ray / SSR 传输协议哪个好? (各种协议对比)](https://www.idleleo.com/05/2071.html)
- [shadowsocks的通信原理以及攻击方法分析](https://wonderkun.cc/2020/02/18/shadowsocks%E7%9A%84%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8A%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E5%88%86%E6%9E%90/)

### 生活中的网络
从小学开始就接触电脑玩游戏，很多概念都耳熟能详，例如：拨号，宽带，猫，光纤，路由器，交换机，AP，DHCP，VLAN等等，但对于具体知识都不清楚，所以学习一下这些知识
网线:
UTP(Unshielded Twisted Pair，非屏蔽双绞线)+RJ45水晶头
双绞线互相绞合用于抗电磁干扰（不知道我的HDMI转Type-C是不是因为电磁干扰，天天灭屏）
1对2对双绞线用于电话线，4对用于以太网，25对或50对大对数电缆用于语音或数据业务的接入
以太网线共有5类4个线对，一共8根线，对应RJ45水晶头的8个凹槽

拨号上网：
通过猫和一根电话线，向服务商申请上网账号后，通过拨号的方式接入到互联网中

光纤（光导纤维）：
利用光的全反射来传递信息

猫（Modem，调制解调器）：
传统意义的猫：可以将电话线中的模拟信号与数字信号互相转换
光猫：将光信号转为数字信号（自动拨号）

ADSL（Asymmetric Digital Subscriber Line，非对称数字用户线路）：
是宽带接入技术中的一种，所谓非对称主要体现在上行速率和下行速率的非对称性上
特点：
- 提供上、下行不对称的传输带宽，下载速度快，上传速度较慢
- 上网、打电话互不干扰（遥想当年一打电话就断网）

DHCP（动态主机配置协议）：
DHCP是基于UDP的应用层协议
服务器分配IP地址、子网掩码和DNS等信息

VLAN（Virtual Local Area Network，虚拟局域网）：
将局域网从逻辑上分为一个个网段。如果所有的局域网处于同一个网段，在实际通信中，将会发生ARP泛洪，浪费了带宽也增加了CPU的负担。
所以通过对交换机对端口进行分组，将物理的LAN在逻辑上划分为多个广播域（VLAN）
不同VLAN之间无法直接通信，需要通过路由器或三层交换机
VLAN种类：
- 基于端口的静态VLAN
- 基于IP（子网）的动态VLAN

交换机：
交换机（二层交换机）属于数据链路层即根据MAC地址进行数据转发
三层交换机，是具有部分路由器功能的交换机，属于网络层，目的是为了加快不同VLAN之间的通信（二层交换机做不到，路由器太慢）

无线AP（Access Point）：
是无线路由器等设备的统称，是无线局域网的一种典型应用，在无线网络中，AP就相当于有线网络的集线器，用来中继和桥接无线信号


